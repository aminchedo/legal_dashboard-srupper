var T=Object.defineProperty;var E=(n,s,a)=>s in n?T(n,s,{enumerable:!0,configurable:!0,writable:!0,value:a}):n[s]=a;var $=(n,s,a)=>E(n,typeof s!="symbol"?s+"":s,a);import{u as F,r as b,j as e}from"./index-DFIyXlnM.js";import{d as M}from"./database-qJYvHaQU.js";const N="http://localhost:3000/api";function w(){const n=localStorage.getItem("accessToken");return n?{Authorization:`Bearer ${n}`}:{}}async function U(n,s,a){const r=await fetch(`${N}/scraping/start`,{method:"POST",headers:{"Content-Type":"application/json",...w()},body:JSON.stringify({url:n,sourceId:s,depth:a})});if(!r.ok)throw new Error("Failed to start scraping");return r.json()}async function _(n=20){const s=await fetch(`${N}/documents?limit=${n}`,{headers:{...w()}});if(!s.ok)throw new Error("Failed to list documents");return(await s.json()).items||[]}async function B(n){const s=await fetch(`${N}/scraping/status/${n}`,{headers:{...w()}});if(!s.ok)throw new Error("Failed to fetch job status");return s.json()}class D{constructor(){$(this,"scrapedUrls",new Set)}async scrapeSite(s,a,r){try{r==null||r(0,`شروع اسکرپ از ${s.name}`);const{jobId:c}=await U(s.url,String(s.id),a.maxPages);let d=!1;for(;!d;){await this.delay(1e3);const l=await B(c),x=typeof l.progress=="number"?l.progress:0;if(r==null||r(x,l.status||"در حال پردازش"),(l.status==="completed"||x>=100)&&(d=!0),l.status==="failed")throw new Error(l.error||"اسکرپ ناموفق بود")}return r==null||r(100,`تکمیل اسکرپ از ${s.name}`),await M.updateSiteLastScraped(s.url),(await _(Math.max(5,Math.min(50,a.maxPages)))).map(l=>{var h;const x=((h=l.metadata)==null?void 0:h.url)||s.url,o=(()=>{try{return new URL(x).hostname}catch{return new URL(s.url).hostname}})();return{id:l.id,url:x,title:l.title,content:l.content,domain:o,category:l.category||"نامشخص",ratingScore:0,wordCount:typeof l.content=="string"?l.content.split(/\s+/).length:0,createdAt:new Date(l.created_at),status:"completed"}})}catch(c){throw console.error(`خطا در اسکرپ ${s.url}:`,c),c}}generateSampleContent(s){const a={دادگستری:[{title:"آیین‌نامه اجرایی دادگاه‌های عمومی",content:"ماده ۱ - دادگاه‌های عمومی در شهرستان‌ها تأسیس و طبق قانون آیین دادرسی مدنی رسیدگی به دعاوی خواهند کرد. ماده ۲ - صلاحیت دادگاه‌ها در رسیدگی به امور مدنی و جزایی بر اساس قوانین مربوطه تعیین می‌شود.",slug:"civil-court-procedures"},{title:"رویه قضایی در امور خانوادگی",content:"دادگاه‌های خانواده مکلف به رسیدگی سریع و عادلانه در امور ازدواج، طلاق، نفقه و حضانت فرزندان هستند. قضات باید با درنظرگیری مصالح خانواده و فرزندان تصمیم‌گیری نمایند.",slug:"family-court-procedures"}],قانون:[{title:"قانون مدنی - کتاب اول: اشخاص",content:"اصل ۱ - هر کس از لحظه تولد تا هنگام مرگ دارای شخصیت حقوقی است. اصل ۲ - اهلیت هر شخص تابع قانون کشوری است که تابعیت او را دارد. اصل ۳ - محل اقامت شخص جایی است که او قصد اقامت دائم در آن را داشته باشد.",slug:"civil-law-persons"},{title:"قانون تجارت - شرکت‌های تجاری",content:"ماده ۱ - شرکت‌های تجاری عبارتند از: شرکت تضامنی، شرکت مختلط غیر سهامی، شرکت مختلط سهامی، شرکت مسئولیت محدود و شرکت سهامی. ماده ۲ - تأسیس شرکت‌ها مستلزم ثبت در اداره ثبت شرکت‌ها است.",slug:"commercial-companies"}],وکالت:[{title:"ضوابط اخلاقی وکلای دادگستری",content:"وکیل دادگستری باید در انجام وظایف خود صادق، امین و متعهد باشد. او نباید پرونده‌هایی را که تعارض منافع دارند همزمان پذیرد. وکیل موظف است اطلاعات محرمانه موکل را حفظ کند.",slug:"lawyer-ethics-code"},{title:"تعرفه حق‌الوکاله سال ۱۴۰۳",content:"حق‌الوکاله وکلای دادگستری بر اساس تعرفه مصوب کانون وکلای دادگستری تعیین می‌شود. این تعرفه ساليانه بازنگری و به‌روزرسانی می‌شود. وکلا موظف به رعایت سقف تعیین شده هستند.",slug:"lawyer-fees-2024"}]},r=a[s.category]||a.قانون,c=[...r];for(let d=0;d<5;d++){const g=d%r.length,u=r[g];c.push({title:`${u.title} - بخش ${d+2}`,content:`${u.content} 

بند اضافی: این بخش حاوی توضیحات تکمیلی و جزئیات بیشتری از قوانین و مقررات مربوطه می‌باشد که جهت اطلاع و استفاده متقاضیان ارائه می‌شود.`,slug:`${u.slug}-section-${d+2}`})}return c}generateId(s){let a=0;for(let r=0;r<s.length;r++){const c=s.charCodeAt(r);a=(a<<5)-a+c,a=a&a}return Math.abs(a).toString(36)}delay(s){return new Promise(a=>setTimeout(a,s))}}const J=new D;function H(){const{data:n}=F(),s=((n==null?void 0:n.sources)||[]).map((t,i)=>({id:i+1,name:t.name,url:t.url||t.base_url,category:t.category||"نامشخص",active:t.status!=="inactive"})),[a,r]=b.useState([]),[c,d]=b.useState({maxPages:10,delay:2,minContentLength:100,enableRating:!0}),[g,u]=b.useState(!1),[l,x]=b.useState(null),[o,h]=b.useState([]),[k,y]=b.useState(!1),I=t=>{r(i=>i.includes(t)?i.filter(p=>p!==t):[...i,t])},R=async()=>{var p;if(!s||a.length===0)return;u(!0),y(!1),h([]);const t=s.filter(m=>a.includes(m.id)),i=[];try{for(let m=0;m<t.length;m++){const j=t[m];x({siteIndex:m,totalSites:t.length,currentSite:j.name,progress:0,status:`شروع اسکرپ از ${j.name}`});const S=await J.scrapeSite(j,c,(f,A)=>{x(C=>C?{...C,progress:f,status:A}:null)});i.push(...S),x({siteIndex:m+1,totalSites:t.length,currentSite:m<t.length-1?((p=t[m+1])==null?void 0:p.name)??"":"",progress:100,status:`تکمیل شد - ${S.length} آیتم جمع‌آوری شد`}),m<t.length-1&&await new Promise(f=>setTimeout(f,1e3))}h(i),y(!0)}catch(m){console.error("Scraping error:",m)}finally{u(!1),x(null)}},L=()=>{u(!1),x(null)},z=()=>{h([]),y(!1)};if(!s)return e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"در حال بارگذاری منابع..."})]})});const v=l?l.siteIndex/l.totalSites*100+l.progress/l.totalSites:0;return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"mb-8",children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900 mb-2",children:"وب اسکرپینگ هوشمند"}),e.jsx("p",{className:"text-gray-600",children:"جمع‌آوری خودکار اطلاعات از منابع حقوقی معتبر"})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsx("div",{className:"lg:col-span-2",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-gray-200 p-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"انتخاب منابع"}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:s.map(t=>e.jsxs("label",{className:"flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:a.includes(t.id),onChange:()=>I(t.id),className:"h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded ml-3"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"font-medium text-gray-900",children:t.name}),e.jsx("div",{className:"text-sm text-gray-500",children:t.category})]})]},t.id))}),a.length>0&&e.jsx("div",{className:"mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg",children:e.jsxs("p",{className:"text-sm text-blue-700",children:[e.jsx(Globe,{className:"inline ml-2",size:16}),a.length," منبع انتخاب شده"]})})]})}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-gray-200 p-6",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:[e.jsx(Settings,{className:"inline ml-2",size:20}),"تنظیمات"]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["حداکثر صفحات هر منبع: ",c.maxPages]}),e.jsx("input",{type:"range",min:"1",max:"50",value:c.maxPages,onChange:t=>d(i=>({...i,maxPages:parseInt(t.target.value)})),className:"w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider",disabled:g})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["تاخیر بین درخواست‌ها: ",c.delay," ثانیه"]}),e.jsx("input",{type:"range",min:"1",max:"10",value:c.delay,onChange:t=>d(i=>({...i,delay:parseInt(t.target.value)})),className:"w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider",disabled:g})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["حداقل طول محتوا: ",c.minContentLength]}),e.jsx("input",{type:"range",min:"50",max:"1000",step:"50",value:c.minContentLength,onChange:t=>d(i=>({...i,minContentLength:parseInt(t.target.value)})),className:"w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider",disabled:g})]}),e.jsxs("label",{className:"flex items-center",children:[e.jsx("input",{type:"checkbox",checked:c.enableRating,onChange:t=>d(i=>({...i,enableRating:t.target.checked})),className:"h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded ml-3",disabled:g}),e.jsx("span",{className:"text-sm text-gray-700",children:"رتبه‌بندی هوشمند محتوا"})]})]})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-gray-200 p-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"وضعیت"}),g?e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:"inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800 mb-4",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-yellow-600 ml-2"}),"در حال اسکرپ..."]}),l&&e.jsxs("div",{children:[e.jsxs("div",{className:"mb-2",children:[e.jsx("p",{className:"text-sm font-medium text-gray-700",children:l.currentSite}),e.jsx("p",{className:"text-xs text-gray-500",children:l.status})]}),e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-2 mb-2",children:e.jsx("div",{className:"bg-blue-600 h-2 rounded-full transition-all duration-300",style:{width:`${v}%`}})}),e.jsxs("p",{className:"text-xs text-gray-600",children:[v.toFixed(1),"% تکمیل شده"]})]})]}):k?e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800 mb-4",children:"✅ تکمیل شده"}),e.jsxs("p",{className:"text-sm text-gray-600",children:[o.length," آیتم جمع‌آوری شد"]})]}):e.jsx("div",{className:"text-center",children:e.jsx("div",{className:"inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-800",children:"⏸️ آماده"})})]}),e.jsx("div",{className:"bg-white rounded-xl shadow-sm border border-gray-200 p-6",children:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("button",{onClick:R,disabled:a.length===0||g,className:"w-full flex items-center justify-center gap-2 bg-blue-600 text-white px-4 py-3 rounded-lg hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed font-medium transition-colors",children:[e.jsx(Play,{size:20}),"شروع اسکرپینگ"]}),e.jsxs("button",{onClick:L,disabled:!g,className:"w-full flex items-center justify-center gap-2 bg-red-600 text-white px-4 py-3 rounded-lg hover:bg-red-700 disabled:bg-gray-300 disabled:cursor-not-allowed font-medium transition-colors",children:[e.jsx(Square,{size:20}),"توقف اسکرپینگ"]}),e.jsxs("button",{onClick:z,disabled:o.length===0,className:"w-full flex items-center justify-center gap-2 bg-gray-600 text-white px-4 py-3 rounded-lg hover:bg-gray-700 disabled:bg-gray-300 disabled:cursor-not-allowed font-medium transition-colors",children:[e.jsx(Trash2,{size:20}),"پاک کردن نتایج"]})]})})]})]}),o.length>0&&e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-gray-200 p-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"نتایج اسکرپینگ"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 mb-6",children:[e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4 text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-blue-600",children:o.length}),e.jsx("div",{className:"text-sm text-blue-700",children:"کل آیتم‌ها"})]}),e.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4 text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-green-600",children:new Set(o.map(t=>t.category)).size}),e.jsx("div",{className:"text-sm text-green-700",children:"دسته‌بندی"})]}),e.jsxs("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-4 text-center",children:[e.jsxs("div",{className:"text-2xl font-bold text-yellow-600",children:[(o.reduce((t,i)=>t+i.ratingScore,0)/o.length*100).toFixed(0),"%"]}),e.jsx("div",{className:"text-sm text-yellow-700",children:"رتبه میانگین"})]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-gray-900 mb-3",children:"نمونه آیتم‌های جمع‌آوری شده:"}),e.jsx("div",{className:"space-y-3 max-h-64 overflow-y-auto",children:o.slice(0,10).map((t,i)=>e.jsx("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"font-medium text-gray-900 truncate",children:t.title}),e.jsxs("div",{className:"flex items-center gap-4 text-sm text-gray-500",children:[e.jsx("span",{children:t.domain}),e.jsx("span",{className:"bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs",children:t.category}),e.jsxs("span",{children:["⭐ ",(t.ratingScore*100).toFixed(0),"%"]})]})]})},t.id))}),o.length>10&&e.jsxs("p",{className:"text-sm text-gray-500 mt-3 text-center",children:["و ",o.length-10," مورد دیگر..."]})]})]}),a.length===0&&e.jsx("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-center gap-2 text-yellow-800",children:[e.jsx(AlertCircle,{size:20}),e.jsx("span",{className:"font-medium",children:"لطفاً حداقل یک منبع را انتخاب کنید"})]})})]})}export{H as default};
